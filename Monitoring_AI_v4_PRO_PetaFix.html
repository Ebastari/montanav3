<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Monitoring_AI_v6_PRO_UI_Enhanced — Kamera + GPS Dinamis + Chart</title>

<!-- ====== FONT: Plus Jakarta Sans (UI Enhancement 1) ====== -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<!-- ====== Libraries (CDN) ====== -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/dist/piexif.min.js"></script>

<style>
  :root{
    --bg:#0b0f1a; --surface:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
  }
  /* UI Enhancement 1: Ganti Font Utama */
  html,body{
    height:100%;margin:0;background:#000;color:var(--text);
    font-family:'Plus Jakarta Sans', system-ui, Segoe UI, Roboto, Arial, sans-serif;
    overflow:hidden
  }
  .app{position:fixed;inset:0;display:flex;flex-direction:column}
  /* Camera layer */
  .camera-wrap{position:relative;flex:1;background:#000;display:flex;align-items:center;justify-content:center}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  canvas#canvas{display:none}
  
  /* UI Enhancement 3: Bayangan lembut dan Transisi */
  .overlay, .toolbar, #map, .card {
    box-shadow: 0 4px 12px rgba(0,0,0,.35);
    transition: all 0.3s ease-out; /* Transisi lembut */
  }
  
  /* Floating toolbar (bawah) */
  .toolbar{position:absolute;bottom:18px;left:0;right:0;display:flex;justify-content:center;gap:18px;z-index:20}
  
  /* UI Enhancement 4: Glow dan Kontras FAB/Button */
  .fab{
    width:70px;height:70px;border-radius:50%;border:6px solid rgba(255,255,255,.9);
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    box-shadow: 0 0 16px rgba(34, 197, 94, .7); /* Glow Hijau */
  }
  .fab::after{content:"";width:100%;height:100%;background:#fff;border-radius:50%;transition:.1s transform}
  .fab:active::after{transform:scale(.9)}
  .btn{
    background:rgba(255,255,255,.2); /* Kontras lebih kuat */
    border:1px solid rgba(255,255,255,.3);
    backdrop-filter:blur(8px);
    color:#fff;border-radius:14px;padding:10px 14px;cursor:pointer;
    transition: background 0.2s, box-shadow 0.2s;
  }
  .btn:hover{ background:rgba(255,255,255,.3); }
  .btn.round{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
  
  /* Top chips */
  .topbar{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;gap:8px;z-index:20;flex-wrap:wrap}
  .chip{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:8px 12px;font-size:13px;margin-top:4px}
  
  /* Overlay info box - draggable */
  .overlay{
    position:absolute;left:16px;bottom:110px;z-index:15;
    background:rgba(0,0,0,.65); /* Kontras lebih kuat */
    border:1px solid rgba(255,255,255,.25); 
    backdrop-filter:blur(10px); /* Blur lebih kuat */
    padding:10px 12px;border-radius:12px;
    min-width:220px;cursor:move;
    opacity: 0.95; /* Sedikit transparan */
  }
  .overlay h4{margin:0 0 6px 0;font-size:14px}
  .overlay .row{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;line-height:1.4}
  
  /* GPS Status Indicator (GPS System Enhancement 1 & 2) */
  #gpsStatusIndicator {
      position: absolute;
      top: 60px; /* Di bawah chip GPS */
      left: 12px;
      padding: 6px 10px;
      background: rgba(0,0,0,.5);
      border-radius: 999px;
      font-size: 13px;
      z-index: 20;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.3s, color 0.3s;
  }
  #gpsStatusIndicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
  }
  .status-low::before { background: var(--danger); }
  .status-medium::before { background: var(--warn); }
  .status-high::before { 
      background: var(--accent); 
      animation: pulse-dot 1.5s infinite; /* Animasi berdenyut */
  }
  @keyframes pulse-dot {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
  }

  /* UI Enhancement 7: Slider gradien */
  .height-panel{
    width:min(520px,92%);background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.18);
    border-radius:16px;padding:10px 14px;
  }
  #tinggiRange{
    width:100%;
    -webkit-appearance: none;
    background: transparent;
  }
  #tinggiRange::-webkit-slider-runnable-track {
    width: 100%;
    height: 8px;
    background: linear-gradient(to right, #22c55e, #3b82f6); /* Gradien Hijau-Biru */
    border-radius: 4px;
  }
  #tinggiRange::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #fff; /* Thumb Putih */
    cursor: pointer;
    margin-top: -6px;
    box-shadow: 0 2px 4px rgba(0,0,0,.4);
  }

  /* Quick options multi-select */
  .quick{position:absolute;left:0;right:0;bottom:160px;display:flex;gap:10px;justify-content:center;z-index:13;pointer-events:none}
  /* UI Enhancement 5: Animasi Hover Tag */
  .quick .tag{
    pointer-events:auto;padding:8px 12px;border-radius:18px;border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.12);user-select:none;cursor:pointer;font-size:13px;
    transition: background 0.2s, transform 0.1s;
  }
  .quick .tag:hover{ transform: scale(1.05); background:rgba(255,255,255,.2); }
  .tag.on{background:var(--accent);color:#052e12;border-color:var(--accent);font-weight:700}
  
  /* Thumbs (UI Enhancement 6: Dihapus dari tampilan kamera) */
  .thumbs{display:none} 

  /* Bottom sheet */
  /* UI Enhancement 2: Transisi lembut untuk sheet */
  .sheet{
    position:fixed;left:0;right:0;bottom:0;height:80vh;background:var(--surface);
    border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -8px 32px rgba(0,0,0,.45);
    transform:translateY(100%);
    transition:.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) transform; /* Transisi Easing yang lebih baik */
    z-index:30;display:flex;flex-direction:column
  }
  .sheet.visible{transform:translateY(0)}
  .handle{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
  .handle .bar{width:50px;height:5px;margin:0 auto;border-radius:3px;background:#374151}
  .sheet-content{flex:1;overflow:auto;padding:14px;display:grid;grid-template-columns:1fr;gap:14px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.grid-2{grid-template-columns:1.2fr 1fr}}
  
  /* Map (Map Enhancement 2: Bayangan Peta) */
  #map{width:100%;height:320px;border-radius:12px;box-shadow: 0 4px 12px rgba(0,0,0,.35);}
  
  /* Toast (Lain-lain 2: Transisi opacity) */
  .toast{
    position:fixed;right:14px;bottom:14px;background:#111827;color:#e5e7eb;border:1px solid #374151;
    border-radius:10px;padding:10px 12px;z-index:60;opacity:0;transform:translateY(8px);
    transition: opacity .25s ease-out, transform .25s ease-out; /* Transisi lebih halus */
  }
  .toast.show{opacity:1;transform:translateY(0)}
  .progress{height:4px;background:#1f2937;border-radius:999px;overflow:hidden;margin-top:6px}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22c55e,#3b82f6)}

  /* Form Input (UI Enhancement 5: Efek fokus input) */
  input[type="number"],input[type="text"]{
    width:100%;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px;color:#e5e7eb;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input[type="number"]:focus,input[type="text"]:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
    outline: none;
  }
  label{font-size:12px;color:#9ca3af}
  
  /* Lain-lain 1: Efek Fade-in pada Review Foto */
  #reviewFoto img {
      opacity: 0;
      animation: fade-in 0.5s ease-out forwards;
  }
  @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }
  
  /* Map Enhancement: Animasi Pulse pada Marker Sehat & Live GPS */
  .leaflet-pulse-icon {
      /* Base style - akan di-override oleh L.circleMarker */
  }
  /* Denyut untuk Marker Sehat/Live */
  .leaflet-pulse-icon.leaflet-marker-icon.leaflet-zoom-animated.leaflet-interactive {
      animation: pulse 2s infinite;
  }
  @keyframes pulse {
      0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); /* Warna Hijau default (Sehat) */
      }
      70% {
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
      100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
  }
</style>
</head>
<body>
<div class="app">
  <div class="camera-wrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="topbar">
      <div class="chip" title="Koordinat terakhir"><span id="chipGPS">GPS: -</span></div>
      <div class="chip" title="Target harian"><span id="chipGoal">Target 100 • 0 selesai</span></div>
    </div>
    
    <!-- GPS System Enhancement 1: Indikator Status GPS Real-time -->
    <div id="gpsStatusIndicator" class="status-low">Menunggu sinyal GPS...</div>

    <!-- Draggable overlay -->
    <div class="overlay" id="overlayInfo">
      <h4>Ringkasan Live</h4>
      <div class="row">Lokasi: <span id="ovLokasi">-</span></div>
      <!-- GPS System Enhancement 3: Tambah Timestamp GPS -->
      <div class="row">Waktu GPS: <span id="ovTimestamp">-</span></div>
      <div class="row">Tinggi: <span id="ovTinggi">10</span> cm</div>
      <div class="row">Jenis: <span id="ovJenis">Akasia</span></div>
      <div class="row">Health: <span id="ovHealth" class="value">-</span></div>
      <div class="row">Foto Lokal: <span id="ovCount">0</span></div>
    </div>

    <!-- Slider tinggi -->
    <div class="height-wrap">
      <div class="height-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div><b>Tinggi Tanaman</b> <span class="muted">(cm)</span></div>
          <div class="value" id="tinggiValueDisplay">10</div>
        </div>
        <input type="range" id="tinggiRange" min="10" max="300" step="1" value="10" aria-label="Tinggi (cm)" title="Geser untuk mengubah tinggi (10–300 cm)">
      </div>
    </div>

    <!-- Quick multi-select jenis -->
    <div class="quick" id="quickContainer">
      <div class="tag on" data-value="Akasia">Akasia</div>
      <div class="tag" data-value="Sengon">Sengon</div>
      <div class="tag" data-value="Nangka">Nangka</div>
      <div class="tag" data-value="Mahoni">Mahoni</div>
      <div class="tag" data-value="Lainnya">Lainnya</div>
    </div>

    <!-- Toolbar bawah -->
    <div class="toolbar">
      <button class="btn round" id="btnGPS" title="Ambil GPS">📍</button>
      <div class="fab" id="btnCapture" title="Ambil Foto"></div>
      <button class="btn round" id="btnToggleSheet" title="Menu & Analitik">☰</button>
    </div>
  </div>

  <!-- Bottom Sheet: Menu, Peta, Dataset -->
  <div class="sheet" id="sheet">
    <div class="handle" id="handle"><div class="bar"></div></div>
    <div class="sheet-content">
      <div class="grid-2">
        <div class="card">
          <h3>Data Monitoring</h3>
          <div class="row-flex">
            <div>
              <label>Tinggi (cm)</label>
              <input id="tinggi" type="number" min="10" max="300" step="1" value="10" placeholder="cth: 120">
            </div>
            <div>
              <label>Jenis Tanaman</label>
              <input id="jenis" type="text" placeholder="Akasia/Sengon/...">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Tahun Tanam</label>
              <input id="tahun" type="number" min="2000" max="2100" placeholder="2025">
            </div>
            <div>
              <label>Lokasi (lat,lon)</label>
              <input id="lokasi" type="text" placeholder="-2.12345, 113.12345">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Pengawas</label>
              <input id="pengawas" type="text" placeholder="Nama pengawas">
            </div>
            <div>
              <label>Vendor</label>
              <input id="vendor" type="text" placeholder="Nama vendor">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Kesehatan</label>
              <input id="kesehatan" type="text" placeholder="Sehat/Merana/Mati">
            </div>
            <div>
              <label>Apps Script URL</label>
              <input id="appsScriptUrl" type="text" value="https://script.google.com/macros/s/AKfycbxG9ljYO7izzI2J7ifkloN01Kgkg1F-nZhVfRfBVQmXlGRqUhWIVxqYMljy354o1Cgo9A/exec" placeholder="https://script.google.com/macros/s/xxx/exec">
            </div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
            <button class="btn" id="btnUpload">Kirim ke Spreadsheet</button>
            <button class="btn" id="btnExportCSV">Export CSV</button>
            <button class="btn" id="btnExportZIP">Export ZIP</button>
          </div>
          <div class="hr"></div>
          <div class="muted" id="status">Status: siap</div>
        </div>

        <div class="card">
          <h3>Peta Interaktif (Leaflet)</h3>
          <div id="map"></div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3>Scatter: Tinggi vs Tahun</h3>
          <canvas id="chartScatter" height="220"></canvas>
        </div>
        <div class="card">
          <h3>Distribusi Tinggi (Histogram)</h3>
          <canvas id="chartHist" height="220"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>Health Index (HSV)</h3>
        <canvas id="chartHealth" height="220"></canvas>
      </div>

      <div class="card">
        <!-- UI Enhancement 6: Thumbnail dipindah ke dalam sheet -->
        <h3>Preview 8 Foto Terakhir</h3>
        <div id="reviewFoto" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px"></div>
      </div>

      <div class="card">
        <h3>Unduhan Cepat</h3>
        <div class="download-links">
          <a href="#" id="dlCSV">Download CSV</a>
          <a href="#" id="dlZIP">Download ZIP (semua foto)</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg">Siap.</div>
  <div class="progress"><i id="toastProg"></i></div>
</div>

<script>
// ==================== STATE GLOBAL ====================
let data = JSON.parse(localStorage.getItem("monitoringData")||"[]");
// Tambah timestamp untuk EXIF dan UI
let lastGPS = { koordinat: "", akurasi: "", timestamp: null }; 
let goalTarget = 100;
let map, markersLayer;
let currentPosMarker = null; 
let scatterChart, histChart, healthChart;
let currentStream = null;
let currentDeviceId = null;
let captureCountForZip = 0;
let gpsWatcherId = null; 

// ==================== DOM ELEMENTS ====================
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnCapture = document.getElementById('btnCapture');
const btnGPS = document.getElementById('btnGPS');
const tinggiRange = document.getElementById('tinggiRange');
const tinggiInput = document.getElementById('tinggi');
const ovLokasi = document.getElementById('ovLokasi');
const ovTimestamp = document.getElementById('ovTimestamp'); 
const chipGPS = document.getElementById('chipGPS');
const gpsStatusIndicator = document.getElementById('gpsStatusIndicator');
const lokasiInput = document.getElementById('lokasi');
const ovTinggi = document.getElementById('ovTinggi');
const ovJenis = document.getElementById('ovJenis');
const ovHealth = document.getElementById('ovHealth');
const ovCount = document.getElementById('ovCount');
const chipGoal = document.getElementById('chipGoal');
const jenisInput = document.getElementById('jenis');
const tahunInput = document.getElementById('tahun');
const pengawasInput = document.getElementById('pengawas');
const vendorInput = document.getElementById('vendor');
const kesehatanInput = document.getElementById('kesehatan');
const appsScriptUrlInput = document.getElementById('appsScriptUrl');
const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const toastProg = document.getElementById('toastProg');
const overlayInfo = document.getElementById('overlayInfo');
const reviewFoto = document.getElementById('reviewFoto');
const tinggiValueDisplay = document.getElementById('tinggiValueDisplay');


// ==================== UTILS ====================
const pad = (n)=> n.toString().padStart(2,'0');
const genId = ()=>{
  const d=new Date();
  return d.getFullYear()+""+pad(d.getMonth()+1)+pad(d.getDate())+"-"+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
};
function showToast(msg, progress=0){
  toastMsg.textContent = msg;
  toast.classList.add('show');
  toastProg.style.width = (progress*100)+'%';
  clearTimeout(window.__toastTO);
  window.__toastTO = setTimeout(()=> toast.classList.remove('show'), 1800);
}
function saveData(){ 
  // Menyimpan data lokal
  localStorage.setItem("monitoringData", JSON.stringify(data)); 
}
function safeFilename(s){ return String(s||'').replace(/[^\w.-]/g,"_"); }
function dataURLtoBlob(dataurl){
  const arr = dataurl.split(',');
  const mime = (arr[0].match(/:(.*?);/)||[])[1]||'image/jpeg';
  const bstr = atob(arr[1]); 
  let n=bstr.length; 
  const u8=new Uint8Array(n); // FIX: Memastikan Uint8Array
  while(n--){ u8[n]=bstr.charCodeAt(n); }
  return new Blob([u8], {type:mime});
}
function parseLatLon(str){
  const p=(str||"").split(',').map(s=>s.trim());
  if(p.length<2) return null;
  const lat=parseFloat(p[0]); const lon=parseFloat(p[1]);
  if(isNaN(lat)||isNaN(lon)) return null;
  return {lat,lon};
}
function toDMS(coord){
  const abs=Math.abs(coord);
  const deg=Math.floor(abs);
  const min=Math.floor((abs-deg)*60);
  const sec=(abs-deg-min/60)*3600;
  return [[deg,1],[min,1],[Math.round(sec*100),100]];
}


// ==================== CAMERA ====================
async function listCameras(){
  if(!navigator.mediaDevices?.enumerateDevices) return;
  const devices = await navigator.mediaDevices.enumerateDevices();
  const vids = devices.filter(d=>d.kind==="videoinput");
  const back = vids.find(v=>/back|rear|environment/i.test(v.label)) || vids[0];
  if(back) startCamera(back.deviceId);
}
async function startCamera(deviceId){
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  const constraints = { video: { deviceId: deviceId? { exact: deviceId } : undefined, facingMode:'environment' } }; 
  try{
    const s = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = s; 
    currentDeviceId = s.getVideoTracks()[0].getSettings().deviceId;
    video.srcObject = s;
  }catch(e){
    showToast("Gagal akses kamera: "+(e.message||e),0);
  }
}

// ==================== GPS (Peningkatan Fungsi Visual) ====================
function updateGPSUI(pos){
    const lat=pos.coords.latitude.toFixed(6);
    const lon=pos.coords.longitude.toFixed(6);
    const acc=pos.coords.accuracy.toFixed(1);
    const ts=new Date(pos.timestamp);
    
    lastGPS = { koordinat: lat+","+lon, akurasi: acc, timestamp: ts };
    lokasiInput.value = lastGPS.koordinat;
    
    const timeStr = ts.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit', second:'2-digit'});

    chipGPS.textContent = "GPS: "+lastGPS.koordinat+" (±"+acc+"m)";
    ovLokasi.textContent = lastGPS.koordinat;
    ovTimestamp.textContent = timeStr;

    // GPS System Enhancement 1: Indikator Status
    gpsStatusIndicator.classList.remove('status-low', 'status-medium', 'status-high');
    
    if(acc < 10){
        gpsStatusIndicator.textContent = "Akurasi Bagus (±<10m)";
        gpsStatusIndicator.classList.add('status-high');
        btnGPS.style.backgroundColor = 'var(--accent)'; 
    } else if (acc < 50) {
        gpsStatusIndicator.textContent = "Akurasi Sedang (±10–50m)";
        gpsStatusIndicator.classList.add('status-medium');
        btnGPS.style.backgroundColor = 'var(--warn)'; 
    } else {
        gpsStatusIndicator.textContent = "Akurasi Rendah (±>50m)";
        gpsStatusIndicator.classList.add('status-low');
        btnGPS.style.backgroundColor = 'var(--danger)'; 
    }

    refreshCurrentPositionMarker(lat, lon, `Posisi terbaru (±${acc}m)`);
}

function startGPSWatch(){
  if(gpsWatcherId !== null){
    navigator.geolocation.clearWatch(gpsWatcherId);
    gpsWatcherId = null;
  }
  btnGPS.style.backgroundColor = 'rgba(255,255,255,.14)'; 
  gpsStatusIndicator.textContent = "🔴 Menunggu sinyal GPS...";
  gpsStatusIndicator.classList.add('status-low');

  showToast("Memulai pengawasan GPS...", 0.2);
  if(!navigator.geolocation){ 
    showToast("Geolocation tidak didukung",0); 
    chipGPS.textContent = "GPS: Gagal";
    gpsStatusIndicator.textContent = "GPS tidak tersedia";
    return; 
  }

  // watchPosition untuk pembaruan lokasi berkelanjutan
  gpsWatcherId = navigator.geolocation.watchPosition(pos=>{
    updateGPSUI(pos);
    showToast("GPS aktif ("+pos.coords.accuracy.toFixed(1)+"m)", 1);
  }, err=>{
    showToast("GPS gagal: "+err.message, 0);
    btnGPS.style.backgroundColor = 'var(--danger)';
    chipGPS.textContent = "GPS: ERROR";
    gpsStatusIndicator.textContent = "GPS tidak tersedia/Gagal";
    gpsStatusIndicator.classList.add('status-low');
    
    // Notifikasi jika gagal karena izin
    if(err.code === 1) { 
      showToast("Gagal akses GPS: Izin ditolak.", 0);
    }
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:1000 }); 
}

// ==================== OVERLAY DRAG ====================
(function enableDrag(){
  const el = overlayInfo;
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  el.addEventListener('pointerdown', e=>{dragging=true; sx=e.clientX; sy=e.clientY; const r=el.getBoundingClientRect(); ox=r.left; oy=r.top; el.setPointerCapture(e.pointerId)});
  el.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    el.style.left = Math.max(6, Math.min(window.innerWidth-200, ox+dx))+"px";
    el.style.top = Math.max(6, Math.min(window.innerHeight-200, oy+dy))+"px";
    el.style.bottom = "auto";
  });
  el.addEventListener('pointerup', ()=> dragging=false);
})();

// ==================== SLIDER SYNC ====================
function syncFromRange(){
  const v = parseInt(tinggiRange.value,10);
  tinggiInput.value = v;
  tinggiValueDisplay.textContent = v;
  ovTinggi.textContent = v;
}
function syncFromInput(){
  let v = parseInt(tinggiInput.value,10);
  if(isNaN(v)) v = 10;
  v = Math.max(10, Math.min(300, v));
  tinggiInput.value = v;
  tinggiRange.value = v;
  tinggiValueDisplay.textContent = v;
  ovTinggi.textContent = v;
}
tinggiRange.addEventListener('input', syncFromRange);
tinggiInput.addEventListener('change', syncFromInput);
syncFromInput();

// ==================== QUICK SELECT ====================
(function initQuick(){
  const c = document.getElementById('quickContainer');
  c.querySelectorAll('.tag').forEach(tag=>{
    tag.addEventListener('click', ()=>{
      tag.classList.toggle('on');
      const sel = [...c.querySelectorAll('.tag.on')].map(t=>t.dataset.value);
      jenisInput.value = sel.join(', ');
      ovJenis.textContent = jenisInput.value || '-';
    });
  });
  jenisInput.addEventListener('input', ()=> ovJenis.textContent = jenisInput.value || '-');
})();

// ==================== SHEET TOGGLE ====================
function toggleSheet(){ sheet.classList.toggle('visible'); }
document.getElementById('btnToggleSheet').addEventListener('click', toggleSheet);
document.getElementById('handle').addEventListener('click', toggleSheet);

// ==================== MAP (Peningkatan Visual Marker) ====================
function initMap(){
  map = L.map('map').setView([-2.00, 118.00], 5); 
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:"© OpenStreetMap"}).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  refreshMarkers();
}

// Map Enhancement 1: Marker dinamis (warna, ukuran, pulse)
function addMapMarker(lat, lon, dataEntry){
  if(!markersLayer) return;
  
  const tinggi = dataEntry.tinggi || 10;
  const kesehatan = dataEntry.kesehatan || 'Sehat';
  
  // Ukuran dinamis: min 6, max 18 (10cm=6, 300cm=18)
  const radius = Math.min(18, Math.max(6, 6 + tinggi / 20)); 

  let color = "#22c55e"; // Sehat
  let className = '';

  if (kesehatan === "Merana") {
      color = "#f59e0b"; // Merana (Kuning)
  } else if (kesehatan === "Mati") {
      color = "#ef4444"; // Mati (Merah)
  }
  
  if (kesehatan === "Sehat") {
      className = 'leaflet-pulse-icon'; 
  }

  const m = L.circleMarker([lat, lon],{ 
    radius: radius, 
    color: color, 
    fillColor: color, 
    fillOpacity:.8,
    className: className, 
    weight: 1 
  });
  
  const html = `<b>${dataEntry.jenis||'-'}</b><br>ID: ${dataEntry.id}<br>Tinggi: ${tinggi}cm<br>Health: ${kesehatan}<br>Lok: ${dataEntry.lokasi}<br><img src="${dataEntry.foto||''}" style="width:140px;margin-top:6px;border-radius:6px"/>`;
  m.addTo(markersLayer).bindPopup(html);
}

// Marker live GPS dengan animasi berdenyut (pulse)
function refreshCurrentPositionMarker(lat, lon, label){
    if(!map) return;
    if(currentPosMarker){ map.removeLayer(currentPosMarker); }
    
    currentPosMarker = L.circleMarker([lat,lon],{ 
      radius: 12, 
      color: "#3b82f6", 
      fillColor: "#3b82f6", 
      fillOpacity: 0.9, 
      weight: 3,
      className: 'leaflet-pulse-icon' // Marker Live juga pakai pulse
    });
    
    currentPosMarker.addTo(map).bindPopup(`<b>${label}</b>`);
    map.panTo([lat, lon]); 
}

function refreshMarkers(){
  if(!markersLayer) return;
  markersLayer.clearLayers(); 
  
  data.forEach(d=>{
    const p = parseLatLon(d.lokasi);
    if(!p) return;
    addMapMarker(p.lat, p.lon, d); 
  });
  
  if(lastGPS.koordinat){
     const p = parseLatLon(lastGPS.koordinat);
     if(p) refreshCurrentPositionMarker(p.lat, p.lon, `Posisi terbaru (±${lastGPS.akurasi}m)`);
  }
}
  
 // ==================== CHARTS (Scatter Axis & Color) ====================
function initCharts() {
  const ctxS = document.getElementById('chartScatter');
  const ctxH = document.getElementById('chartHist');
  const ctxHe = document.getElementById('chartHealth');
  
  scatterChart = new Chart(ctxS, {
    type: 'scatter',
    data: { 
      datasets: [{
        label: 'Tinggi vs Tahun',
        data: [],
        pointRadius: 6,
        pointBorderWidth: 1
      }]
    },
    options: { 
      responsive: true, 
      plugins: { legend: { display: true } }, 
      scales: { 
        x: { 
          title: { display: true, text: 'Tahun' },
          // 🔴 Chart Enhancement: Sumbu X hanya tahun bulat 2024–2027 (tanpa desimal)
          type: 'linear',
          min: 2024,
          max: 2027,
          ticks: { 
            stepSize: 1,
            callback: function(value) {
              return Math.floor(value); // 🔴 pastikan tahun tampil bulat
            }
          }
        }, 
        y: { 
          title: { display: true, text: 'Tinggi Tanaman (cm)' } // Label sumbu Y tetap jelas
        }
      }
    }
  });

  histChart = new Chart(ctxH, {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Jumlah', data: [] }] },
    options: { 
      responsive: true, 
      plugins: { legend: { display: false } }, 
      scales: { 
        x: { title: { display: true, text: 'Rentang Tinggi (cm)' } }, 
        y: { title: { display: true, text: 'Count' } } 
      } 
    }
  });

  healthChart = new Chart(ctxHe, {
    type: 'bar',
    data: { labels: ['Sehat', 'Merana', 'Mati'], datasets: [{ label: 'Jumlah', data: [0, 0, 0] }] },
    options: { 
      responsive: true, 
      plugins: { legend: { display: false } } 
    }
  });

  refreshCharts();
}

function refreshCharts(){
  // Scatter
  // Chart Enhancement 3: Warna titik sesuai kesehatan
  const scatterData = data.filter(d => d.tahun && d.tinggi).map(d => {
    let color = '#3b82f6'; 
    if (d.kesehatan === 'Sehat') color = 'var(--accent)';
    else if (d.kesehatan === 'Merana') color = 'var(--warn)';
    else if (d.kesehatan === 'Mati') color = 'var(--danger)';
    
    return {
      x: +d.tahun, 
      y: +d.tinggi, 
      backgroundColor: color, 
      borderColor: '#fff'
    };
  });
  
  scatterChart.data.datasets[0].data = scatterData;
  scatterChart.update();

  // Histogram bins
  const heights = data.map(d=>+d.tinggi).filter(Boolean);
  const bins = [0,50,100,150,200,250,300];
  const counts = new Array(bins.length-1).fill(0);
  heights.forEach(h=>{
    for(let i=0;i<bins.length-1;i++){
      if(h>bins[i] && h<=bins[i+1]){ counts[i]++; break; }
    }
  });
  const labels = bins.slice(0,-1).map((b,i)=>`${bins[i]+1}-${bins[i+1]}`);
  histChart.data.labels = labels;
  histChart.data.datasets[0].data = counts;
  histChart.update();

  // Health
  const healthCounts = {Sehat:0, Merana:0, Mati:0};
  data.forEach(d=>{ if(healthCounts[d.kesehatan]!==undefined) healthCounts[d.kesehatan]++; });
  healthChart.data.datasets[0].data = [healthCounts.Sehat, healthCounts.Merana, healthCounts.Mati];
  healthChart.update();
}


// ==================== EXIF WRITER ====================
function insertExif(dataUrl, meta){
  if(typeof piexif === 'undefined'){ console.warn('piexif not loaded'); return dataUrl; }
  try{
    const ts = meta.timestamp || new Date(); 
    const exifTime = ts.getFullYear()+":"+pad(ts.getMonth()+1)+":"+pad(ts.getDate())+" "+pad(ts.getHours())+":"+pad(ts.getMinutes())+":"+pad(ts.getSeconds());
    const gps = {};
    const ll = parseLatLon(meta.koordinat||"");
    
    if(ll){
      gps[piexif.GPSIFD.GPSLatitudeRef] = ll.lat<0? "S":"N";
      gps[piexif.GPSIFD.GPSLatitude] = toDMS(ll.lat);
      gps[piexif.GPSIFD.GPSLongitudeRef] = ll.lon<0? "W":"E";
      gps[piexif.GPSIFD.GPSLongitude] = toDMS(ll.lon);
      gps[piexif.GPSIFD.GPSMapDatum] = "WGS-84";
      
      if(meta.akurasi){
        const dop = Math.round(parseFloat(meta.akurasi)*100); 
        gps[piexif.GPSIFD.GPSDOP] = [dop,100];
      }
    }
    
    const comment = `ID:${meta.id}; Tinggi:${meta.tinggi}cm; Jenis:${meta.jenis}; Lokasi:${meta.koordinat}; Pengawas:${meta.pengawas||''}`;
    const exifObj = {
      "0th": {
        [piexif.ImageIFD.Make]: "Monitoring_AI_v6_PRO",
        [piexif.ImageIFD.Model]: "Web Camera",
        [piexif.ImageIFD.Software]: "v6_PRO_UI_Enhanced",
        [piexif.ImageIFD.DateTime]: exifTime,
        [piexif.ImageIFD.Orientation]: 1
      },
      "Exif": {
        [piexif.ExifIFD.DateTimeOriginal]: exifTime,
        [piexif.ExifIFD.DateTimeDigitized]: exifTime,
        [piexif.ExifIFD.UserComment]: piexif.helper.encodeText(comment)
      },
      "GPS": gps
    };
    const exifStr = piexif.dump(exifObj);
    return piexif.insert(exifStr, dataUrl);
  }catch(e){
    console.warn("EXIF insert failed:", e);
    return dataUrl;
  }
}

// ==================== AI HSV (Simple) ====================
function analyzeHSV(imgData){
  const {data:arr,width,height} = imgData;
  let r=0,g=0,b=0,c=0;
  for(let y=0;y<height;y+=4){
    for(let x=0;x<width;x+=4){
      const i=(y*width+x)*4;
      r+=arr[i]; g+=arr[i+1]; b+=arr[i+2]; c++;
    }
  }
  r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
  const mx=Math.max(r,g,b)/255, diff=mx-Math.min(r,g,b)/255;
  let h=0; let s = mx===0?0:diff/mx; let v=mx;
  if(diff!=0){
    const rr=r/255, gg=g/255, bb=b/255;
    if(mx===rr){ h=60*(((gg-bb)/diff)%6); }
    else if(mx===gg){ h=60*(((bb-rr)/diff)+2); }
    else { h=60*(((rr-gg)/diff)+4); }
  }
  if(h<0) h+=360;
  let label="Sehat";
  if(v<0.25 || (h>0 && h<25)) label="Mati";
  else if((h>=25 && h<=65) && v>0.25) label="Merana";
  return {h:Math.round(h), s:+s.toFixed(2), v:+v.toFixed(2), label};
}

// ==================== CAPTURE FLOW (Async/Await) ====================
async function capture(){
  if(!video.videoWidth){ showToast("Video belum siap",0); return; }
  
  if(!lastGPS.koordinat){
    showToast("GPS belum terkunci. Ambil foto tanpa koordinat akurat.", 0);
  }

  const id = genId();
  const tinggi = parseInt(tinggiInput.value||tinggiRange.value,10) || 10;
  if(tinggi<=0){ showToast("Tinggi tidak valid",0); return; }

  // Draw frame & AI HSV
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const sample = ctx.getImageData(0,0,canvas.width,canvas.height);
  const hsv = analyzeHSV(sample);
  kesehatanInput.value = kesehatanInput.value || hsv.label;
  ovHealth.textContent = hsv.label;

  // Watermark
  const margin=20, lh=Math.max(18, Math.round(canvas.height*0.022));
  ctx.font = `bold ${lh}px sans-serif`;
  ctx.fillStyle = 'rgba(255,255,255,.96)';
  ctx.strokeStyle = 'rgba(0,0,0,.75)';
  ctx.lineWidth = Math.max(3, Math.round(lh*0.15));
  const tanggal = new Date().toLocaleString('id-ID');
  const lines = [
    `Lokasi: ${lokasiInput.value||lastGPS.koordinat||'-'}`,
    `Tinggi: ${tinggi} cm`,
    `Jenis: ${jenisInput.value||'-'}`,
    `Koordinat: ${lastGPS.koordinat||'-'}`,
    `Akurasi: ±${lastGPS.akurasi||'-'} m`,
    `Tanggal: ${tanggal}`
  ];
  lines.forEach((t,i)=>{
    const y = canvas.height - margin - (lines.length-1-i)*(lh+8);
    ctx.strokeText(t, margin, y);
    ctx.fillText(t, margin, y);
  });
  const brand = "Monitoring_AI_v6_PRO_UI_Enhanced";
  const w = ctx.measureText(brand).width;
  ctx.strokeText(brand, canvas.width - margin - w, margin+lh);
  ctx.fillText(brand, canvas.width - margin - w, margin+lh);

  // Encode
  let dataUrl = canvas.toDataURL('image/jpeg', 0.9);

  // Insert EXIF
  dataUrl = insertExif(dataUrl, {
    id, tinggi, jenis: jenisInput.value, koordinat: lastGPS.koordinat, akurasi: lastGPS.akurasi, pengawas: pengawasInput.value, timestamp: lastGPS.timestamp || new Date()
  });

  // Auto download foto
  try{
    const blob = dataURLtoBlob(dataUrl);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `foto_${safeFilename(id)}.jpg`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }catch(e){ console.warn("Auto download gagal:", e); }

  // Save entry
  const entry = {
    id, tanggal, lokasi: lokasiInput.value||lastGPS.koordinat||"", pekerjaan: "", tahun: tahunInput.value||"", jenis: jenisInput.value||"", tim: "", tinggi,
    kesehatan: kesehatanInput.value||hsv.label, koordinat: lastGPS.koordinat||"", akurasi: lastGPS.akurasi||"",
    x: parseLatLon(lastGPS.koordinat||"")?.lon || "", y: parseLatLon(lastGPS.koordinat||"")?.lat || "",
    pengawas: pengawasInput.value||"", vendor: vendorInput.value||"", foto: dataUrl 
  };
  data.push(entry);
  saveData();
  ovCount.textContent = data.length;
  chipGoal.textContent = `Target ${goalTarget} • ${data.length} selesai`;

  // Update UI
  refreshMarkers();
  refreshCharts();
  renderReview();

  if(navigator.vibrate) navigator.vibrate(30);
  showToast("Foto tersimpan",1);

  // Auto upload
  const url = (appsScriptUrlInput.value||"").trim();
  if(url){
    await uploadToAppsScript(entry, url); 
  }

  // Auto ZIP
  captureCountForZip++;
  if(captureCountForZip % 10 === 0){
    await autoZipNow();
  }
}

// ==================== UPLOAD HELPER ====================
async function uploadToAppsScript(entry, url){
    try{
        const payload = {
          ID: entry.id, Tanggal: entry.tanggal, Lokasi: entry.lokasi, Pekerjaan: entry.pekerjaan, Tinggi: entry.tinggi,
          Koordinat: entry.koordinat, X: entry.x, Y: entry.y, Tanaman: entry.jenis, "Tahun Tanam": entry.tahun,
          Pengawas: entry.pengawas, Vendor: entry.vendor, Gambar: entry.foto,
          Gambar_Nama_File: `Montana V2_Images/Gambar Montana (${entry.id}).jpg`, LINK:""
        };
        await fetch(url, {
          method:'POST',
          body: JSON.stringify(payload),
          headers: {'Content-Type': 'text/plain'}
        });
        showToast("📤 Data terkirim (Apps Script)",1);
    }catch(e){
      console.warn("Upload gagal:", e);
      showToast("Upload gagal (check Apps Script)",0);
    }
}

// ==================== THUMBNAIL & REVIEW ====================
function renderReview(){
  reviewFoto.innerHTML = '';
  // Batasi 8 foto terakhir
  data.slice(-8).reverse().forEach((d, index)=>{
    const img=document.createElement('img');
    img.src=d.foto||'';
    img.style.width='100%'; img.style.height='90px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
    // Tambahkan delay untuk efek fade-in yang berurutan
    img.style.animationDelay = `${index * 0.05}s`; 
    reviewFoto.appendChild(img);
  });
}

// ==================== UPLOAD LAST (Tombol Manual) ====================
async function uploadLast(){
  if(!data.length){ showToast("Belum ada data",0); return; }
  const last = data[data.length-1];
  const url = (appsScriptUrlInput.value||"").trim();
  if(!url){ showToast("Apps Script URL kosong",0); return; }
  showToast("Mengirim...", .3);
  await uploadToAppsScript(last, url);
}

// ==================== EXPORT CSV & ZIP ====================
function buildCSV(){
  let csv = "ID,Tanggal,Lokasi,Tinggi,Koordinat,X,Y,Jenis,Tahun,Pengawas,Vendor,Kesehatan,Akurasi\n";
  data.forEach(d=>{
    csv += `"${d.id}","${d.tanggal}","${d.lokasi}",${d.tinggi},"${d.koordinat}",${d.x},${d.y},"${d.jenis}","${d.tahun}","${d.pengawas||''}","${d.vendor||''}","${d.kesehatan}","${d.akurasi}"\n`;
  });
  return csv;
}
function exportCSV(){
  if(!data.length){ showToast("Tidak ada data",0); return; }
  const csv = buildCSV();
  saveAs(new Blob([csv], {type:'text/csv;charset=utf-8;'}), 'monitoring.csv');
  showToast("CSV diunduh",1);
}
async function exportZIP(filename='monitoring_images.zip'){
  if(!data.length){ showToast("Tidak ada data",0); return; }
  if(typeof JSZip === 'undefined'){ showToast("Error: JSZip belum dimuat.", 0); return; }
  const zip = new JSZip();
  const csv = buildCSV();
  data.forEach((d,i)=>{
    if(d.foto){
      const b64 = (d.foto.split(',')[1]||''); 
      if(b64) zip.file(`images/foto_${i+1}_${safeFilename(d.id)}.jpg`, b64, {base64:true});
    }
  });
  zip.file("data.csv", csv);
  const blob = await zip.generateAsync({type:'blob', compression: "DEFLATE"}); 
  saveAs(blob, filename);
  showToast("ZIP diunduh",1);
}
async function autoZipNow(){
  showToast("Batch foto ke-"+Math.ceil(data.length/10)+" siap diunduh (ZIP)", .6);
  await exportZIP(`monitoring_batch_${Math.ceil(data.length/10)}.zip`);
}

// ==================== EVENTS ====================
btnGPS.addEventListener('click', async ()=>{
  if(DeviceOrientationEvent && DeviceOrientationEvent.requestPermission){
    try{ await DeviceOrientationEvent.requestPermission(); }catch(e){}
  }
  startGPSWatch(); 
});
btnCapture.addEventListener('click', capture);
document.addEventListener('keydown', (e)=>{ if(e.key==="Enter") capture(); });
document.getElementById('btnUpload').addEventListener('click', uploadLast);
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
document.getElementById('btnExportZIP').addEventListener('click', ()=>exportZIP());
document.getElementById('dlCSV').addEventListener('click', (e)=>{e.preventDefault(); exportCSV();});
document.getElementById('dlZIP').addEventListener('click', (e)=>{e.preventDefault(); exportZIP();});

// ==================== INIT ====================
(async function init(){
  try{
    await listCameras();
    initMap();
    initCharts();
    
    ovCount.textContent = data.length;
    chipGoal.textContent = `Target ${goalTarget} • ${data.length} selesai`;
    
    // Restore Apps Script URL
    const savedUrl = localStorage.getItem('appsScriptUrl')||"";
    if(!savedUrl && appsScriptUrlInput.value){ localStorage.setItem('appsScriptUrl', appsScriptUrlInput.value); }
    else if(savedUrl){ appsScriptUrlInput.value = savedUrl; }
    appsScriptUrlInput.addEventListener('input', ()=> localStorage.setItem('appsScriptUrl', appsScriptUrlInput.value||""));
    renderReview();

    // MEMULAI GPS SECARA OTOMATIS SAAT APLIKASI DIMUAT
    startGPSWatch(); 
  }catch(e){
    console.error("Kesalahan saat inisialisasi:", e);
  }
})();
</script>
</body>
</html>
